# Implementation Plan

- [x] 1. 設定永続化とデフォルト復元
- [x] 1.1 SQLiteスキーマとメモリフォールバック
  - settingsテーブルを設計準拠のBreathPattern構造（bpm, durationSec[60-300|null], breath.type/inhale/hold/exhale/cycles）で初期化し、Web/テスト時のメモリ実装も整備する
  - _Requirements: 1.1,1.4,1.5,3.1_
- [x] 1.2 SettingsRepository実装とデフォルト適用
  - 保存/取得で値域を検証しつつデフォルトを返すフェイルセーフを備える（bpm40-120, duration60-300|null, cycles null=∞）
  - _Requirements: 1.1,1.4,1.5,1.6,3.1_

- [x] 2. セッション設定UI＆ガイド準備
- [x] 2.1 心拍設定UI（BPM/時間）と自動復元
  - セッション画面に常設し、編集→保存→再訪で値が反映されることを確認する
  - _Requirements: 1.1,1.4,1.5_
- [x] 2.2 呼吸設定UI（吸・止・吐・cycles）とプリセットショートカット
  - BreathPatternを直接編集でき、プリセットボタンで即時適用できるようにする。振動設定と独立して保持
  - _Requirements: 3.1,3.3_
- [x] 2.3 モード選択後に即時開始/停止でガイドを確認できるようにする（プレビュー廃止）
  - 心拍モード: 1拍1振動を現在のBPMで再生（Webは無振動でエラーなし）、円アニメでパルスを表示
  - 呼吸モード: 吸/止/吐に同期した円アニメを表示し、フェーズ開始で単発振動を再生。モード切替で対象を自動切替
  - _Requirements: 1.3,2.3,2.4_
- [x] 2.4 モード単一表示と開始ボタン統一
  - 画面上部でモード（振動/呼吸）を選択し、選択中モードの設定と開始ボタンのみ表示する。開始ボタンは共通の「開始」に統一する
  - _Requirements: 3.4,3.5_
- [x] 2.5 視覚ガイドの常時表示と待機状態
  - 開始前からガイド要素を表示し、未実行時は待機状態で静止表示する。開始で選択モードのアニメーションに遷移し、停止で待機に戻す
  - _Requirements: 2.1,2.3,2.4_

- [x] 3. ガイダンスエンジン＆ハプティクス
- [x] 3.1 心拍ガイド（±5%補正）
  - 60000/bpm間隔で単発振動を出し、タイマードリフトを補正して±5%以内を目標とする。active管理と重複開始防止
  - _Requirements: 2.1,2.2,2.3_
- [x] 3.2 呼吸ガイド進行
  - BreathPattern（2/3フェーズ, cycles null=∞）に従いフェーズ経過を通知し、各フェーズ開始で単発振動を出しつつ、duration上限またはcycles完了で終了する。視覚ガイド用ステップイベントを発火
  - _Requirements: 2.1,2.3,2.4,3.2,3.3_
- [x] 3.3 ハプティクスアダプタ
  - 振動不可（permission/disabled等）をResultで通知し、上位で視覚のみ継続できるようにする
  - _Requirements: 1.3,2.2_

- [x] 4. セッション開始・停止・完了フロー
- [x] 4.1 Start/Stop処理
  - 設定読込→Guidance開始、duration/手動停止の早い方で停止し状態を更新する
  - _Requirements: 2.1,2.3,3.2,3.3_
- [x] 4.2 任意記録モーダルとSessionUseCase.complete
  - 実行前/実行中/停止後のいずれでも「記録する」から開ける。pre/post心拍、improvement、guideType、breath/BPMを入力でき、UseCaseで検証して保存要求を発行する
  - _Requirements: 4.1,4.2,4.3,4.4,4.5_
- [x] 4.3 SessionRepositoryで記録保存
  - session_recordsへ記録時刻と開始/終了時刻、ガイド種別、心拍、改善度、breath/BPMを保存する
  - _Requirements: 4.1,4.2,4.3,4.4,4.5_
- [x] 4.4 SessionScreenをUseCase/GuidanceEngineに接続し設定どおり継続動作させる
  - Start/Stopボタンを SessionUseCase.start/stop に置き換え、BPM/時間/呼吸フェーズ/cycles/durationを反映する
  - GuidanceEngineのonStep/onComplete/onStopでVisualGuideと状態表示を同期し、仮タイマーを撤去する
  - _Requirements: 1.3,2.1,2.2,2.3,2.4,3.2,3.3_
- [x] 4.5 振動強度オプションの検討（非対応でクローズ）
  - Expo Goでは振幅制御ができないため、強度UI/設定は提供しない方針とする。実装は行わず、将来ネイティブ対応が必要になった場合に再タスク化する
  - _Requirements: 1.2_
- [x] 4.6 セッション完了入力の手動起動
  - セッション画面に「記録する」セカンダリボタンを常時表示し、実行前/実行中/停止後いずれでも手動記録モーダルを開けるようにする（実行中は現在設定を初期値に、停止中は空入力で開く）
  - _Requirements: 4.1,4.2,4.3,4.4,4.5_
- [x] 4.7 BPM/時間の長押しステッパー対応
  - BPM/時間の±ボタンに長押しで連続インクリメント/デクリメントを実装し、キーボード不要で素早く調整できるようにする（範囲ガード: BPM 40-120, 時間60-300/∞）
  - _Requirements: 1.1,1.5_

- [x] 5. 履歴一覧・詳細表示
- [x] 5.1 履歴一覧（recordedAt DESC）
  - 各セッションの開始/終了心拍・ガイド種別・改善度・breath/BPMを表示する
  - _Requirements: 4.5_
- [x] 5.2 履歴詳細（一覧タップでモーダル表示）
  - 履歴カードをタップしたときに詳細モーダルを開き、一覧内で完結させる
  - 新規画面やタブは追加せず、2タブ構成を維持する
  - _Requirements: 5.1_
- [x] 5.3 履歴編集（記録モーダルの流用）
  - 記録モーダルを編集モードでも使えるようにし、既存データを初期値として表示する
  - 編集結果を保存し、履歴に即時反映されるようにする
  - _Requirements: 4.2,4.3,4.4,4.5_
- [x] 5.4 履歴更新の保存処理
  - 既存記録を更新できる保存処理を追加する（開始/終了心拍、改善度、ガイド種別、breath/BPM）
  - _Requirements: 4.2,4.3,4.4_
- [x] 5.5 履歴一覧のページング取得
  - SessionRepositoryにページング取得を追加し、recordedAt+idのカーソルで最新順にlimit件取得できるようにする（SQLite/Web両対応）
  - _Requirements: 4.5,4.6_
- [x] 5.6 履歴一覧の無限スクロール
  - LogsScreenで初回ロード→末尾到達時の追加ロードを実装し、取得結果を既存リストに追記する（ロード中ガード・重複排除）
  - _Requirements: 4.6,5.3_
- [x] 5.7 初回フォーカス時のみ最新を取得し、再表示では自動更新しない
  - 履歴タブが最初に表示されたタイミングで最新順の履歴を取得する
  - タブ再表示時は直前の表示内容を維持する
  - 初回取得が完了するまでの状態遷移を整理する
  - _Requirements: 4.7,4.8_
- [x] 5.8 プル更新で最新1ページを取得し重複なく先頭追加する
  - 下に引っ張って更新したときに最新順の履歴を再取得する
  - 既存一覧は保持し、重複を排除しながら先頭に追加する
  - ページングのカーソルは維持して追加入力の挙動を崩さない
  - _Requirements: 4.9_
- [x] 5.9 空の履歴表示でもプル更新を実行できるようにする
  - 履歴が0件の表示状態でも更新操作を可能にする
  - 取得結果に応じて空表示と一覧表示を切り替える
  - _Requirements: 4.9_
- [x] 5.10 履歴の更新挙動に対するテストを追加する
  - 初回フォーカス時の取得と再表示時の自動更新抑止を確認する
  - プル更新で重複排除しながら先頭追加されることを確認する
  - 空の履歴表示でも更新が動作することを確認する
  - _Requirements: 4.7,4.8,4.9_
- [x] 5.11 履歴の一括削除APIを追加する
  - SessionRepositoryにdeleteMany(ids)を追加し、SQLite/Memory双方でトランザクション削除を実装する
  - idsが空のときはno-op、存在しないIDは無視する
  - _Requirements: 4.12,4.13_
- [x] 5.12 履歴一覧の選択モードUIを追加する
  - 「選択」開始で複数選択に入る。カード左に常設の余白を確保し、選択時は左中央にチェックバッジ（✓）を表示して背景色で強調する
  - 選択件数の表示は不要
  - 選択解除/キャンセルで通常表示に戻す
  - 選択モード中はタップで詳細モーダルを開かず、選択操作のみ受け付ける
  - _Requirements: 4.10,4.11,4.14_
- [x] 5.13 一括削除の確認と一覧反映を実装する
  - 削除前に確認ダイアログで件数を提示する
  - 確認後にdeleteManyを実行し、成功時は一覧から即時除外する
  - 失敗時はエラーを表示して再試行を促す
  - _Requirements: 4.12,4.13_
- [ ] 5.14 deleteManyの実装テストを追加する
  - SessionRepositoryのdeleteMany（SQLite/Memory）の正常系/空配列/存在しないIDを確認する
  - _Requirements: 4.12,4.13_
- [ ] 5.15 一括削除のUIテストを追加する
  - 選択モードの開始/解除、複数選択、削除後の一覧反映を確認する
  - _Requirements: 4.10,4.11,4.12,4.13,4.14_

- [x] 6. バリデーションとエラーハンドリング
- [x] 6.1 入力バリデーション
  - BPM/時間/心拍/improvement/cyclesの範囲チェックとエラーメッセージ表示。送信ブロックを実装
  - _Requirements: 1.1,1.5,2.2,4.1,4.2,4.3,4.4_
- [x] 6.2 ハプティクス・DB失敗時のフォールバック
  - 振動不可時は視覚のみ継続（振動/呼吸両モード）、保存失敗時はリトライとユーザー通知を行う
  - _Requirements: 1.3,2.2,2.4,4.3_

- [x] 7. テスト
- [x] 7.1 Unitテスト
  - GuidanceEngine（振動補正、呼吸フェーズ進行、終了条件）、SettingsRepository保存/復元、SessionUseCase開始/停止/完了をカバー
  - _Requirements: 1.1,1.3,1.4,1.5,2.1,2.2,2.3,2.4,3.1,3.2,3.3,4.1,4.2,4.3,4.4,4.5_
- [x] 7.2 Integration/UIテスト
  - 設定編集→保存→モード別開始/停止→完了入力→履歴表示を通し、Webで振動なしでもエラーにならないことを確認
  - _Requirements: 1.1,1.3,1.4,1.5,2.1,2.2,2.3,2.4,3.1,3.2,3.3,4.1,4.2,4.3,4.4,4.5,5.1,5.2,5.3,5.4_

- [x] 8. ナビゲーション（タブ）再構成
- [x] 8.1 タブを「セッション」「履歴」の2つに限定し不要タブを削除する
  - ルート `app/_layout.tsx` を Session/Logs の2タブに統一し、旧Home/Exploreや (tabs) グループを削除する
  - _Requirements: 5.1_
- [x] 8.2 デフォルトタブを「セッション」に設定し1タップで開始操作へ導く
  - initialRouteName を session に設定し、戻る動線でもセッションへ戻ることを確認する
  - _Requirements: 5.2_
- [x] 8.3 履歴タブから最新順一覧へ1タップで遷移できるようにする
  - ルーティングを logs 直下に揃え、表示データを最新順で取得する
  - _Requirements: 5.3_
- [x] 8.4 タブ切替時に設定状態や入力途中を保持する
  - Tabsのアンマウント抑止設定とシングルトンSessionViewModelで状態を保持し、往復で設定が失われないことを確認する
  - _Requirements: 5.4,1.4_
