# リサーチ＆設計判断ログ

---
**目的**: この機能の設計を支える調査結果と判断理由を記録する。

**使い方**:
- 調査活動とその結果を残す。
- `design.md` に書き切れない比較・根拠を補足する。
- 将来の監査や再利用のための参照情報を保持する。
---

## サマリー
- **対象機能**: calm-heart-rate-app
- **ディスカバリ範囲**: 既存機能拡張（プレビュー廃止→即時開始/停止フロー、タブをセッション/履歴の2つに再編）
- **主要な発見**:
  - 振動ガイドのBPM精度は±5%以内を目標とし、Expo環境では`setInterval`精度に依存するため短時間セッション前提は継続。
  - Expo Go / Development Build では Foreground Service 不可。画面ON前提＋`expo-keep-awake`で対応する方針は据え置き。
  - タブを「セッション」「履歴」の2つに限定し初期表示をセッションにすることで、開始動線を1タップに保ちつつ履歴導線を明示できる。タブ切替時の状態保持はViewModel/Storeで対処する。

## リサーチログ

### 振動リズム精度とBPM計算
- **背景**: BPM指定の振動間隔を±5%以内で維持したい。
- **知見**:
  - BPM→間隔(ms)は `60000 / BPM`。JavaScriptタイマーは負荷やバックグラウンドで遅延し得る。
  - Expo Go ではバックグラウンドに弱く、画面ON前提。短時間（数分以内）かつ前面であれば実用範囲。
- **含意**: `GuidanceEngine` はタイマー遅延を検知し、累積誤差を補正するロジックを設計する（実装時の留意点）。設計ではAPI契約に「±5%以内を目標」と明記。

### ハプティクスAPIとプラットフォーム差異
- **背景**: Android専用。Expoで端末差異を吸収したい。
- **知見**:
  - `expo-haptics` は強度プリセットを提供するが、連続パターンは自前で組み立てる必要がある。
  - 端末設定で振動が無効の場合がある。Resultで失敗理由を返し、視覚のみ継続するフォールバックが必要。
- **含意**: `HapticsAdapter` がResult型でエラーを返す契約を持つ。振動不可ならUIで警告、ガイドは視覚のみ継続。

### セッションデータ保存
- **背景**: 前後心拍と主観評価を履歴で保持。
- **知見**:
  - expo-sqlite で軽量テーブルを管理。Bare移行時も互換性を保ちやすい。
- **含意**: `SessionRepository` を継続採用。心拍入力は任意でNULLを許容。

### 画面消灯と継続性
- **背景**: 画面OFFでも振動を続けたい要望。
- **知見**:
  - Expo Go では不可。`expo-keep-awake` でスリープ防止し、前面使用を前提にする。
- **含意**: 要件外として明記。将来 Bare 化と Foreground Service で拡張可能性を保持。

### ナビゲーション（タブ構成）
- **背景**: 不要タブ(Home/Explore)が残存し主要機能導線が散っている。
- **知見**:
  - Expo Router tabs で `initialRouteName="session"` を設定し、`detachInactiveScreens=false` `lazy=false` でアンマウントを避けられる。
  - タブ切替時の状態保持は、SessionViewModel をシングルトンとして外部に持ち、UIはそれを参照する形にすれば再マウントでも設定が残る。
- **含意**: 2タブ化し、セッションタブは開始/停止に集中、履歴タブは一覧を即表示。状態保持はシングルトンVM＋アンマウント回避で担保する。

## アーキテクチャパターン評価
| 選択肢 | 概要 | 強み | リスク/制約 | 備考 |
|--------|------|------|-------------|------|
| MVVM + UseCase + Repository | UI/ドメイン/データ分離 | テスト容易、一方向依存 | コンポーネントが増える | 現構成を継続 |
| VM直呼び | ViewModelが直接Adapter/Repoを叩く | 実装最小 | VM肥大・再利用性低下 | 採用せず |

## 設計判断

### 判断: BPMベース振動ガイドをコアに据える
- **背景**: 心拍同期が主目的。呼吸テンポは補助。
- **代替**: 呼吸テンポ主体 + 振動は付随 / BPM主体 + 呼吸はオプション
- **採用**: BPM主体。視覚ガイドは任意で同期表示。
- **理由**: パニック時に最小操作で振動同期を開始することを優先。
- **トレードオフ**: 呼吸ガイド利用時は振動との両立ロジックが追加。

### 判断: Webフォールバック維持

### 判断: 呼吸ガイドは2/3フェーズ＋サイクル指定で提供
- **背景**: 吸う/吐くのみのシンプルガイドと、ボックス呼吸系（吸う/止める/吐く）双方のニーズがある。サイクル回数を明示すると途中変更が不要になる。
- **代替**: 2フェーズのみ／3フェーズのみ／プリセット固定
- **採用**: 2フェーズと3フェーズの両方を設定可能にし、cyclesに整数または∞を許容。
- **理由**: 繰り返し前提の呼吸ガイドで柔軟性を担保しつつ、UIを1画面で切替表示できる範囲に収める。
- **トレードオフ**: 設定項目が増えるが、モード切替時に関連項目のみ表示して誤タップを抑制する。
- **背景**: 開発中に `w` を押してもクラッシュしないようにしたい。
- **採用**: `.web` メモリアダプタを維持。
- **理由**: 無振動でもUI確認ができ、リグレッションを防げる。

### 判断: プレビュー廃止し、開始＝即時実行へ統一
- **背景**: 1.3 で「プレビュー1回再生」がユーザー体感に合わず、開始/停止で十分と判断。
- **代替**: プレビュー継続 / 短時間お試しモード / 即時開始のみ
- **採用**: 即時開始のみ（時間上限 or 手動停止）。開始時点で視覚ガイドを表示し、停止で終了。
- **理由**: 操作を一本化しUX簡素化。API/コードも単一フローに揃う。
- **トレードオフ**: 設定確認だけの軽量確認がなくなるが、開始→即停止で代替可。テストケースを更新。

### 判断: タブを「セッション」「履歴」の2つに限定
- **背景**: 既存Home/Exploreタブが不要で導線が散っている。
- **代替**: タブ廃止（単一画面+遷移）、現状維持、2タブ置換。
- **採用**: 2タブ（Session/Logs）。初期タブはセッション。
- **理由**: 開始導線を1タップに保ちつつ履歴を明確に露出できる。タブ数削減で認知負荷も低い。
- **トレードオフ**: タブ切替時の設定保持が課題。解として (1) Tabs のアンマウント抑止設定 (2) SessionViewModel をシングルトン化 で対応する。

## リスクと対応策
- タイマー遅延でBPM精度がずれる → ±5%以内を目標と明記し、実装で累積補正を行う。長時間セッションは上限設定。
- 端末振動が無効 → Resultでエラーを返し、視覚のみ継続＋ユーザー通知。
- 画面OFFで継続不可 → 前面前提をUIで明示。将来 Bare + Foreground Service をオプションとして設計に残す。

## 参考文献
- Expo Docs — Haptics, SQLite, Keep Awake
