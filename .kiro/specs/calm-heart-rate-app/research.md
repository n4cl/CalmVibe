# リサーチ＆設計判断ログ

---
**目的**: この機能の設計を支える調査結果と判断理由を記録する。

**使い方**:
- 調査活動とその結果を残す。
- `design.md` に書き切れない比較・根拠を補足する。
- 将来の監査や再利用のための参照情報を保持する。
---

## サマリー
- **対象機能**: calm-heart-rate-app
- **ディスカバリ範囲**: 新規機能
- **主要な発見**:
  - プラットフォームは Android 専用。外部デバイス連携や自動心拍計測は行わず、端末内の振動と視覚ガイドに特化する。
  - 実装は React Native + Expo（Expo Go + Development Build）。必要に応じて prebuild/CNG でネイティブプロジェクトを生成し、Foreground Service などを追加できる構成を維持する。振動は `expo-haptics` を利用。
  - セッション履歴（前後心拍、ガイド種別、体感、改善度）はローカルDB（expo-sqlite）に保存し、個人情報は最小限にする。

## リサーチログ

### 振動APIの選定（Expo）
- **背景**: Expo環境で振動を扱い、端末差異を吸収したい。
- **参照ソース**: expo-haptics ドキュメント。
- **知見**:
  - `expo-haptics` はパターンや強度プリセットを提供し、ネイティブコード不要で利用できる。
  - 端末側で振動無効設定の場合は失敗し得るため、Resultで通知し、視覚ガイドのみ継続するフォールバックが必要。
- **示唆**: HapticsAdapterが `expo-haptics` を内部で呼び、失敗時の理由を返す。

### セッションデータ保存方式（Expo）
- **背景**: 前後心拍と主観評価を履歴として残し、後から閲覧できるようにしたい。
- **参照ソース**: expo-sqlite ドキュメント。
- **知見**:
  - expo-sqlite で軽量テーブルを作り、シンプルなDAO層で扱える。
  - 将来 Bare 移行時も SQLite 互換で移植が容易。
- **示唆**: `SessionRecord` と `Settings` テーブルを定義し、Repository経由でアクセスする。

- **背景**: 画面消灯中もガイドを継続したいが、Expo Go / Development Build では前面実行が基本。
- **参照ソース**: Expoドキュメント（Background tasks, Keep Awake）。
- **知見**:
  - Expo Go / Development Build ではネイティブ Foreground Service が使えない。画面ON/前面を前提にし、`expo-keep-awake` でスリープを防ぐのが現実的。
  - 通知からの制御は将来 Bare 移行時に対応を検討。
- **示唆**: 短時間・前面実行を前提とし、バックグラウンド継続はスコープ外と明記。

## アーキテクチャパターン評価
| 選択肢 | 概要 | 強み | リスク/制約 | 備考 |
|--------|------|------|-------------|------|
| MVVM + UseCase + Repository | UIとドメインを分離し、データも独立 | テスト容易、一方向依存を維持 | コンポーネント数が増える | 現構成を採用 |
| VM直呼び（UseCase省略） | ViewModelがRepository/Engineを直接呼ぶ | 実装が最小 | VMが肥大し再利用性低下 | 簡略化オプションとして不採用 |

## 設計判断

### 判断: 振動/視覚ガイド実行の抽象化
- **背景**: Expo環境で端末差異を吸収しつつテスト容易性を確保したい。
- **検討案**:
  1. UIから直接 `expo-haptics` を呼び、視覚アニメを各画面が持つ
  2. ドメイン層に `GuidanceEngine` を置き、パターン生成と進行を一元化し、Platformアダプタ経由で振動を実行
- **採用**: 2 を採用。`GuidanceEngine` がパターン生成と進行管理を担い、`HapticsAdapter` がデバイス実行。視覚アニメはUI層でテンポ同期表示。
- **理由**: テスト容易性とAPI差異の隔離。
- **トレードオフ**: アダプタ実装の追加コスト。
- **フォローアップ**: 端末設定で振動禁止の場合の挙動をE2Eで確認（視覚のみ継続）。

### 判断: ローカルDBスキーマ
- **背景**: 前後心拍と主観評価を履歴として保持したい。
- **検討案**:
  1. KeyValue（Storage）で簡易保存
  2. SQLite（expo-sqlite）で構造化保存
- **採用**: 2 を採用。
- **理由**: 検索・並び替え・将来拡張に耐えるため。
- **トレードオフ**: 初期実装がやや重い。
- **フォローアップ**: Bare 移行やエクスポート要件が出た場合にスキーマ拡張を検討。

- **背景**: Expo Go / Development Build では画面消灯時の継続が制約される。
- **検討案**:
1. 画面前面前提でタイマー実行＋`expo-keep-awake`でスリープ防止
2. prebuild/CNG でネイティブ生成後に Foreground Service で通知付き実行
- **採用**: 現状は 1（短時間セッション前提）。
- **理由**: 追加ネイティブなしで実現できる最小構成。
- **トレードオフ**: 画面を閉じるとガイド継続できない。将来 Bare 移行で改善余地。
- **フォローアップ**: 端末スリープ設定で動作確認し、必要なら移行を検討。

## リスクと対応策
- 振動が端末設定で無効化されている → 視覚ガイドのみで継続し、エラーメッセージを表示。
- 画面OFFでガイド継続できない（Expo Go / Development Build の制約） → `expo-keep-awake` でスリープ防止。要件が固まれば prebuild/CNG 後に Foreground Service 対応を検討。
- 手入力心拍の信頼性が低い → 任意入力とし、履歴に入力有無を保持。

## 参考文献
- Expo Docs — Haptics, SQLite, Keep Awake
