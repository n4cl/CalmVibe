# リサーチ＆設計判断ログ

---
**目的**: この機能の設計を支える調査結果と判断理由を記録する。

**使い方**:
- 調査活動とその結果を残す。
- `design.md` に書き切れない比較・根拠を補足する。
- 将来の監査や再利用のための参照情報を保持する。
---

## サマリー
- **対象機能**: calm-heart-rate-app
- **ディスカバリ範囲**: 新規機能（振動リズム同期を主目的に要件再定義、呼吸ガイドを2/3フェーズ＋サイクル設定で拡張）
- **主要な発見**:
  - 振動ガイドのBPM精度は±5%以内を目標とし、Expo環境では`setInterval`精度に依存する。長時間/バックグラウンドは制約があるため短時間セッション前提。
  - Expo Go / Development Build ではネイティブ Foreground Service が使えない。画面ON・前面＋`expo-keep-awake`でスリープ防止が実用的。必要なら prebuild/CNG でネイティブ化し、将来 Foreground Service を追加する余地を残す。
  - Webでは振動不可のためメモリ実装フォールバックを維持し、プレビューやガイドは落ちずに動くことを優先する。

## リサーチログ

### 振動リズム精度とBPM計算
- **背景**: BPM指定の振動間隔を±5%以内で維持したい。
- **知見**:
  - BPM→間隔(ms)は `60000 / BPM`。JavaScriptタイマーは負荷やバックグラウンドで遅延し得る。
  - Expo Go ではバックグラウンドに弱く、画面ON前提。短時間（数分以内）かつ前面であれば実用範囲。
- **含意**: `GuidanceEngine` はタイマー遅延を検知し、累積誤差を補正するロジックを設計する（実装時の留意点）。設計ではAPI契約に「±5%以内を目標」と明記。

### ハプティクスAPIとプラットフォーム差異
- **背景**: Android専用。Expoで端末差異を吸収したい。
- **知見**:
  - `expo-haptics` は強度プリセットを提供するが、連続パターンは自前で組み立てる必要がある。
  - 端末設定で振動が無効の場合がある。Resultで失敗理由を返し、視覚のみ継続するフォールバックが必要。
- **含意**: `HapticsAdapter` がResult型でエラーを返す契約を持つ。振動不可ならUIで警告、ガイドは視覚のみ継続。

### セッションデータ保存
- **背景**: 前後心拍と主観評価を履歴で保持。
- **知見**:
  - expo-sqlite で軽量テーブルを管理。Bare移行時も互換性を保ちやすい。
- **含意**: `SessionRepository` を継続採用。心拍入力は任意でNULLを許容。

### 画面消灯と継続性
- **背景**: 画面OFFでも振動を続けたい要望。
- **知見**:
  - Expo Go では不可。`expo-keep-awake` でスリープ防止し、前面使用を前提にする。
- **含意**: 要件外として明記。将来 Bare 化と Foreground Service で拡張可能性を保持。

## アーキテクチャパターン評価
| 選択肢 | 概要 | 強み | リスク/制約 | 備考 |
|--------|------|------|-------------|------|
| MVVM + UseCase + Repository | UI/ドメイン/データ分離 | テスト容易、一方向依存 | コンポーネントが増える | 現構成を継続 |
| VM直呼び | ViewModelが直接Adapter/Repoを叩く | 実装最小 | VM肥大・再利用性低下 | 採用せず |

## 設計判断

### 判断: BPMベース振動ガイドをコアに据える
- **背景**: 心拍同期が主目的。呼吸テンポは補助。
- **代替**: 呼吸テンポ主体 + 振動は付随 / BPM主体 + 呼吸はオプション
- **採用**: BPM主体。視覚ガイドは任意で同期表示。
- **理由**: パニック時に最小操作で振動同期を開始することを優先。
- **トレードオフ**: 呼吸ガイド利用時は振動との両立ロジックが追加。

### 判断: Webフォールバック維持

### 判断: 呼吸ガイドは2/3フェーズ＋サイクル指定で提供
- **背景**: 吸う/吐くのみのシンプルガイドと、ボックス呼吸系（吸う/止める/吐く）双方のニーズがある。サイクル回数を明示すると途中変更が不要になる。
- **代替**: 2フェーズのみ／3フェーズのみ／プリセット固定
- **採用**: 2フェーズと3フェーズの両方を設定可能にし、cyclesに整数または∞を許容。
- **理由**: 繰り返し前提の呼吸ガイドで柔軟性を担保しつつ、UIを1画面で切替表示できる範囲に収める。
- **トレードオフ**: 設定項目が増えるが、モード切替時に関連項目のみ表示して誤タップを抑制する。
- **背景**: 開発中に `w` を押してもクラッシュしないようにしたい。
- **採用**: `.web` メモリアダプタを維持。
- **理由**: 無振動でもUI確認ができ、リグレッションを防げる。

## リスクと対応策
- タイマー遅延でBPM精度がずれる → ±5%以内を目標と明記し、実装で累積補正を行う。長時間セッションは上限設定。
- 端末振動が無効 → Resultでエラーを返し、視覚のみ継続＋ユーザー通知。
- 画面OFFで継続不可 → 前面前提をUIで明示。将来 Bare + Foreground Service をオプションとして設計に残す。

## 参考文献
- Expo Docs — Haptics, SQLite, Keep Awake
